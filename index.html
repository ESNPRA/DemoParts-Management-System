<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMOé›¶ä»¶ç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 40px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-card, .main-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-card {
            max-width: 400px;
            margin: 0 auto;
        }

        .main-card {
            max-width: 100%;
            text-align: left;
            padding: 60px;
        }

        h1 {
            color: #333;
            margin-bottom: 40px;
            text-align: center;
            font-size: 2.5em;
        }

        h2, h3 {
            color: #333;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .btn-secondary { background: linear-gradient(135deg, #757f9a 0%, #d7dde8 100%); }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 40px;
            justify-content: center;
        }

        .nav-buttons .btn {
            padding: 15px 35px;
            font-size: 18px;
            min-width: 140px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            table-layout: fixed; /* ğŸ”¥ å›ºå®šè¡¨æ ¼ä½ˆå±€ï¼Œè®“å¯¬åº¦è¨­å®šç”Ÿæ•ˆ */
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            word-wrap: break-word; /* ğŸ”¥ å…è¨±é•·æ–‡å­—æ›è¡Œ */
            vertical-align: top; /* ğŸ”¥ é ‚éƒ¨å°é½Šï¼Œè®“æŒ‰éˆ•æ’åˆ—æ›´æ•´é½Š */
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        .search-container input {
            flex: 3;
            padding: 15px;
            font-size: 16px;
        }

        .search-container select {
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            padding: 15px;
            font-size: 16px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 400;
            text-transform: none;
        }

        .status-available {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-borrowed {
            background-color: #fecaca;
            color: #991b1b;
        }

        .conflict-warning {
            background: #fecaca;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f87171;
        }

        .conflict-warning strong {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º -->
        <div id="userInfo" class="user-info" style="display: none;">
            <span id="userDisplay"></span>
            <button class="btn btn-secondary" onclick="logout()" style="margin-left: 10px; padding: 5px 15px; font-size: 14px;">ç™»å‡º</button>
        </div>

        <!-- ç™»å…¥é é¢ -->
        <div id="loginPage" class="login-card">
            <h1>ç³»çµ±ç™»å…¥</h1>
            <div class="form-group">
                <label>ä¿¡ç®±</label>
                <input type="email" id="email" placeholder="è«‹è¼¸å…¥ä¿¡ç®±">
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            </div>
            <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
            <div style="margin-top: 20px; color: #6b7280; font-size: 14px;">
                <p><strong>æ¸¬è©¦å¸³è™Ÿï¼š</strong></p>
                <p>ç®¡ç†å“¡ï¼š11 / 11</p>
                <p>RAåŒä»ï¼š22 / 22</p>
                <p>DEMOå€Ÿç”¨è€…ï¼š33 / 33</p>
            </div>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½é é¢ -->
        <div id="mainPage" class="main-card" style="display: none;">
            <h1>DEMOé›¶ä»¶ç®¡ç†ç³»çµ±</h1>
            
            <!-- å°èˆªæŒ‰éˆ• -->
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="showPage('searchPage')">æŸ¥è©¢æ—¢æœ‰è³‡æ–™</button>
                <button id="addPartBtn" class="btn btn-success" onclick="showPage('addPartPage')" style="display: none;">è³‡æ–™è¼¸å…¥</button>
                <button id="borrowRecordsBtn" class="btn btn-secondary" onclick="showPage('borrowRecordsPage')" style="display: none;">å€Ÿå‡ºç´€éŒ„</button>
                <button id="userMgmtBtn" class="btn btn-danger" onclick="showPage('userManagementPage')" style="display: none;">æ¬Šé™ç®¡ç†</button>
            </div>

            <!-- æŸ¥è©¢é é¢ -->
            <div id="searchPage" class="page active">
                <h2>æŸ¥è©¢æ—¢æœ‰è³‡æ–™</h2>
                <button class="btn btn-secondary" onclick="showPage('mainPage')">è¿”å›ä¸»é </button>
                
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="è«‹è¼¸å…¥å‹è™Ÿé—œéµå­—æœå°‹" onkeypress="if(event.key === 'Enter') searchParts()">
                    <button class="btn btn-primary" onclick="searchParts()" style="padding: 15px 25px; min-width: auto;">
                        <span style="font-size: 18px;">ğŸ”</span>
                    </button>
                    <select id="sortBy" onchange="searchParts()">
                        <option value="model">ä¾å‹è™Ÿæ’åº</option>
                        <option value="status">ä¾ç‹€æ…‹æ’åº</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr id="partsTableHeader">
                            <!-- å‹•æ…‹ç”Ÿæˆè¡¨é ­ -->
                        </tr>
                    </thead>
                    <tbody id="partsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- è³‡æ–™è¼¸å…¥é é¢ -->
            <div id="addPartPage" class="page">
                <h2>æ–°å¢é›¶ä»¶è³‡æ–™</h2>
                <button class="btn btn-secondary" onclick="showPage('mainPage')">è¿”å›ä¸»é </button>
                
                <div class="form-group">
                    <label>å‹è™Ÿ *</label>
                    <input type="text" id="partModel" placeholder="è«‹è¼¸å…¥é›¶ä»¶å‹è™Ÿ">
                </div>
                <div class="form-group">
                    <label>æ•¸é‡ *</label>
                    <input type="number" id="partQuantity" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>å­˜æ”¾ä½ç½® *</label>
                    <input type="text" id="partLocation" placeholder="è«‹è¼¸å…¥å­˜æ”¾ä½ç½®">
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="partNotes" placeholder="è«‹è¼¸å…¥å‚™è¨»è³‡è¨Š"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="partHidden" style="width: auto; margin-right: 8px;">
                        éš±è—æ­¤é›¶ä»¶ï¼ˆä¸è®“DEMOå€Ÿç”¨è€…æŸ¥è©¢åˆ°ï¼‰
                    </label>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                        å‹¾é¸å¾Œï¼Œåªæœ‰ç®¡ç†å“¡å’Œå»ºç«‹è€…å¯ä»¥çœ‹åˆ°æ­¤é›¶ä»¶
                    </div>
                </div>
                <div class="form-group">
                    <label>é›¶ä»¶ç…§ç‰‡</label>
                    <input type="file" id="partPhoto" accept="image/*" onchange="previewImage(this)">
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e1e5e9;">
                    </div>
                </div>
                <button id="addPartButton" class="btn btn-success" onclick="addPart()">æ–°å¢é›¶ä»¶</button>
            </div>

            <!-- å€Ÿå‡ºç´€éŒ„é é¢ -->
            <div id="borrowRecordsPage" class="page">
                <h2>å€Ÿå‡ºç´€éŒ„</h2>
                <button class="btn btn-secondary" onclick="showPage('mainPage')">è¿”å›ä¸»é </button>
                
                <table>
                    <thead>
                        <tr>
                            <th>é›¶ä»¶å‹è™Ÿ</th>
                            <th>å€Ÿç”¨äºº</th>
                            <th>Email</th>
                            <th>é›»è©±</th>
                            <th>æ™‚é–“</th>
                            <th>æ•¸é‡</th>
                            <th>é¡å‹</th>
                            <th>ç‹€æ…‹</th>
                            <th>ç”¨é€”èªªæ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="borrowRecordsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- æ¬Šé™ç®¡ç†é é¢ -->
            <div id="userManagementPage" class="page">
                <h2>æ¬Šé™ç®¡ç†</h2>
                <button class="btn btn-secondary" onclick="showPage('mainPage')">è¿”å›ä¸»é </button>
                <button class="btn btn-success" onclick="openAddUserModal()" style="margin-left: 10px;">æ–°å¢ä½¿ç”¨è€…</button>
                
                <table>
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>Email</th>
                            <th>é›»è©±</th>
                            <th>è§’è‰²</th>
                            <th>ç‹€æ…‹</th>
                            <th>ä¿®æ”¹å¯†ç¢¼</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å€Ÿç”¨ç”³è«‹å½ˆçª— -->
        <div id="borrowModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeBorrowModal()">&times;</span>
                <div class="modal-body">
                    <h3>ç”³è«‹å€Ÿç”¨</h3>
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="borrowerName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="borrowerEmail" placeholder="è«‹è¼¸å…¥æ‚¨çš„Email">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±</label>
                        <input type="tel" id="borrowerPhone" placeholder="è«‹è¼¸å…¥æ‚¨çš„é›»è©±">
                    </div>
                    <div class="form-group">
                        <label>å€Ÿç”¨é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="borrowStartDate">
                    </div>
                    <div class="form-group">
                        <label>å€Ÿç”¨çµæŸæ—¥æœŸ</label>
                        <input type="date" id="borrowEndDate">
                    </div>
                    <div class="form-group">
                        <label>å€Ÿç”¨æ•¸é‡</label>
                        <input type="number" id="borrowQuantity" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>ç”¨é€”èªªæ˜</label>
                        <textarea id="borrowDescription" placeholder="è«‹èªªæ˜å€Ÿç”¨ç›®çš„å’Œç”¨é€”"></textarea>
                    </div>
                    <div id="conflictWarning" class="conflict-warning" style="display: none;">
                        <strong>âŒ åº«å­˜è¡çªè­¦å‘Š</strong>
                        <div id="conflictDetails"></div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="submitBorrow()">ç¢ºèªç”³è«‹</button>
                        <button class="btn btn-secondary" onclick="closeBorrowModal()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç…§ç‰‡æ”¾å¤§é¡¯ç¤ºå½ˆçª— -->
        <div id="imageModal" class="modal">
            <div class="modal-content" style="text-align: center; padding: 20px;">
                <span class="close" onclick="closeImageModal()">&times;</span>
                <img id="modalImage" style="max-width: 90%; max-height: 80vh; object-fit: contain;">
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼å½ˆçª— -->
        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePasswordModal()">&times;</span>
                <div class="modal-body">
                    <h3>ä¿®æ”¹å¯†ç¢¼</h3>
                    <div class="form-group">
                        <label>å¸³è™Ÿ</label>
                        <input type="text" id="passwordUserEmail" readonly style="background-color: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>æ–°å¯†ç¢¼</label>
                        <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <div class="form-group">
                        <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input type="password" id="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="updatePassword()">ç¢ºèªä¿®æ”¹</button>
                        <button class="btn btn-secondary" onclick="closePasswordModal()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº«å­˜èª¿æ•´å½ˆçª— -->
        <div id="inventoryModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeInventoryModal()">&times;</span>
                <div class="modal-body">
                    <h3>èª¿æ•´åº«å­˜æ•¸é‡</h3>
                    <div class="form-group">
                        <label>é›¶ä»¶å‹è™Ÿ</label>
                        <input type="text" id="inventoryPartModel" readonly style="background-color: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>ç›®å‰åº«å­˜æ•¸é‡</label>
                        <input type="number" id="currentInventoryQuantity" readonly style="background-color: #f3f4f6;">
                    </div>
                    <div class="form-group">
                        <label>æ–°çš„åº«å­˜æ•¸é‡ *</label>
                        <input type="number" id="newInventoryQuantity" min="0" placeholder="è«‹è¼¸å…¥æ–°çš„åº«å­˜æ•¸é‡">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                            æ³¨æ„ï¼šèª¿æ•´åº«å­˜å¯èƒ½æœƒå½±éŸ¿ç¾æœ‰çš„é ç´„å’Œå€Ÿå‡ºè¨˜éŒ„
                        </div>
                    </div>
                    <div id="inventoryWarning" style="display: none; background: #fecaca; color: #991b1b; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #f87171;">
                        <strong>âš ï¸ åº«å­˜èª¿æ•´è­¦å‘Š</strong>
                        <div id="inventoryWarningDetails"></div>
                    </div>
                    <div class="form-group">
                        <label>èª¿æ•´åŸå›  *</label>
                        <textarea id="inventoryReason" placeholder="è«‹èªªæ˜èª¿æ•´åº«å­˜çš„åŸå› " rows="3"></textarea>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="updateInventory()">ç¢ºèªèª¿æ•´</button>
                        <button class="btn btn-secondary" onclick="closeInventoryModal()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ä½¿ç”¨è€…å½ˆçª— -->
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeAddUserModal()">&times;</span>
                <div class="modal-body">
                    <h3>æ–°å¢ä½¿ç”¨è€…</h3>
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="addUserName" placeholder="è«‹è¼¸å…¥å§“å" onblur="validateName()">
                        <div id="addUserNameError" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="addUserEmail" placeholder="è«‹è¼¸å…¥Email" onblur="validateEmail()">
                        <div id="addUserEmailError" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>é›»è©± *</label>
                        <input type="tel" id="addUserPhone" placeholder="è«‹è¼¸å…¥é›»è©±" onblur="validatePhone()">
                        <div id="addUserPhoneError" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç¢¼ *</label>
                        <input type="password" id="addUserPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onblur="validatePassword()">
                        <div id="addUserPasswordError" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>ç¢ºèªå¯†ç¢¼ *</label>
                        <input type="password" id="addUserConfirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼" onblur="validateConfirmPassword()">
                        <div id="addUserConfirmPasswordError" style="color: #dc2626; font-size: 12px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰² *</label>
                        <select id="addUserRole">
                            <option value="demo_user">DEMOå€Ÿç”¨è€…</option>
                            <option value="ra_staff">RAåŒä»</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                        </select>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="addNewUser()">ç¢ºèªæ–°å¢</button>
                        <button class="btn btn-secondary" onclick="closeAddUserModal()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let users = [
            { email: '11', password: '11', role: 'admin' },
            { email: '22', password: '22', role: 'ra_staff' },
            { email: '33', password: '33', role: 'demo_user' }
        ];
        let parts = [];
        let borrowRecords = [];
        let reservations = [];
        let inventoryLogs = []; // ğŸ”¥ æ–°å¢ï¼šåº«å­˜èª¿æ•´è¨˜éŒ„
        let currentUser = null;
        let currentBorrowingPart = null;
        let currentInventoryPart = null; // ğŸ”¥ æ–°å¢ï¼šç•¶å‰èª¿æ•´åº«å­˜çš„é›¶ä»¶

        // é ç´„å–®ç‹€æ…‹å¸¸æ•¸
        const RESERVATION_STATUS = {
            PENDING: 'pending',
            CONFIRMED: 'confirmed',
            ACTIVE: 'active',
            COMPLETED: 'completed',
            CANCELLED: 'cancelled'
        };

        // æ ¸å¿ƒåº«å­˜è¨ˆç®—å‡½æ•¸ - ä¿®æ­£æ—¥æœŸæ¯”è¼ƒé‚è¼¯
        function getAvailableQuantityAtDate(partId, targetDate) {
            const part = parts.find(p => p.id === partId);
            if (!part) return 0;
            
            let totalUsed = 0;
            const targetTime = targetDate.getTime(); // ä½¿ç”¨æ™‚é–“æˆ³é€²è¡Œæ¯”è¼ƒ
            
            console.log('=== åº«å­˜è¨ˆç®—è©³ç´°æª¢æŸ¥ ===');
            console.log('æª¢æŸ¥é›¶ä»¶ID:', partId, 'æª¢æŸ¥æ—¥æœŸ:', targetDate.toLocaleDateString());
            console.log('ç›®æ¨™æ—¥æœŸæ™‚é–“æˆ³:', targetTime);
            console.log('æ‰€æœ‰é ç´„è¨˜éŒ„:', reservations);
            console.log('æ‰€æœ‰å€Ÿå‡ºè¨˜éŒ„:', borrowRecords);
            
            // è¨ˆç®—å€Ÿå‡ºè¨˜éŒ„çš„ä½¿ç”¨é‡ï¼ˆåªè¨ˆç®—å¯¦éš›å€Ÿå‡ºä¸­çš„ï¼‰
            borrowRecords.forEach(record => {
                if (record.partId === partId && record.status === 'å€Ÿå‡ºä¸­') {
                    const recordStartTime = new Date(record.borrowTime).getTime();
                    const recordEndTime = record.borrowPeriod ? new Date(record.borrowPeriod).getTime() : null;
                    
                    console.log('æª¢æŸ¥å€Ÿå‡ºè¨˜éŒ„:', record.borrowerName);
                    console.log('  é–‹å§‹æ™‚é–“æˆ³:', recordStartTime, 'çµæŸæ™‚é–“æˆ³:', recordEndTime);
                    console.log('  ç›®æ¨™æ™‚é–“æˆ³:', targetTime);
                    
                    if (recordStartTime <= targetTime && (!recordEndTime || recordEndTime >= targetTime)) {
                        totalUsed += (record.quantity || 1);
                        console.log('âœ… å€Ÿå‡ºè¨˜éŒ„ç”Ÿæ•ˆ! ä½”ç”¨æ•¸é‡:', record.quantity || 1, 'å€Ÿç”¨äºº:', record.borrowerName);
                    } else {
                        console.log('âŒ å€Ÿå‡ºè¨˜éŒ„ä¸åœ¨æ­¤æ—¥æœŸç¯„åœå…§');
                    }
                }
            });
            
            // è¨ˆç®—é ç´„è¨˜éŒ„çš„ä½¿ç”¨é‡ï¼ˆåªè¨ˆç®—ç¢ºèªçš„é ç´„ï¼‰
            reservations.forEach(reservation => {
                console.log('æª¢æŸ¥é ç´„è¨˜éŒ„:', reservation);
                if (reservation.partId === partId) {
                    console.log('é›¶ä»¶IDåŒ¹é…ï¼Œæª¢æŸ¥ç‹€æ…‹:', reservation.status);
                    if (reservation.status === RESERVATION_STATUS.CONFIRMED) {
                        
                        const reservationStartTime = new Date(reservation.startDate).getTime();
                        const reservationEndTime = new Date(reservation.endDate).getTime();
                        
                        console.log('é ç´„æœŸé–“æ™‚é–“æˆ³:', reservationStartTime, '~', reservationEndTime);
                        console.log('ç›®æ¨™æ™‚é–“æˆ³:', targetTime);
                        console.log('é–‹å§‹æ—¥æœŸæ¯”è¼ƒ:', reservationStartTime, '<=', targetTime, '=', reservationStartTime <= targetTime);
                        console.log('çµæŸæ—¥æœŸæ¯”è¼ƒ:', reservationEndTime, '>=', targetTime, '=', reservationEndTime >= targetTime);
                        
                        if (reservationStartTime <= targetTime && reservationEndTime >= targetTime) {
                            totalUsed += reservation.quantity;
                            console.log('âœ… é ç´„è¨˜éŒ„ç”Ÿæ•ˆ! ä½”ç”¨æ•¸é‡:', reservation.quantity, 'é ç´„äºº:', reservation.borrowerName);
                        } else {
                            console.log('âŒ é ç´„è¨˜éŒ„ä¸åœ¨æ­¤æ—¥æœŸç¯„åœå…§');
                        }
                    } else {
                        console.log('âŒ é ç´„ç‹€æ…‹ä¸æ˜¯å·²ç¢ºèª:', reservation.status);
                    }
                } else {
                    console.log('âŒ é›¶ä»¶IDä¸åŒ¹é… - é ç´„è¨˜éŒ„:', reservation.partId, 'æŸ¥è©¢ID:', partId);
                }
            });
            
            const available = Math.max(0, part.quantity - totalUsed);
            console.log('æœ€çµ‚è¨ˆç®—çµæœ - ç¸½åº«å­˜:', part.quantity, 'å·²ä½¿ç”¨:', totalUsed, 'å¯ç”¨:', available);
            console.log('=== åº«å­˜è¨ˆç®—æª¢æŸ¥çµæŸ ===');
            
            return available;
        }

        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DEMOé›¶ä»¶ç®¡ç†ç³»çµ±å·²è¼‰å…¥');
            
            // ç³»çµ±å·²æº–å‚™å°±ç·’ï¼Œç„¡é è¨­æ¸¬è©¦è³‡æ–™
            console.log('ç³»çµ±å·²æº–å‚™å°±ç·’');
            console.log('é ç´„è¨˜éŒ„:', reservations);
            console.log('å€Ÿå‡ºè¨˜éŒ„:', borrowRecords);
            console.log('é›¶ä»¶è¨˜éŒ„:', parts);
        });

        // ç™»å…¥åŠŸèƒ½
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'block';
                document.getElementById('userInfo').style.display = 'block';
                
                let roleDisplay = '';
                switch(user.role) {
                    case 'admin': roleDisplay = 'ç®¡ç†å“¡'; break;
                    case 'ra_staff': roleDisplay = 'RAåŒä»'; break;
                    case 'demo_user': roleDisplay = 'DEMOå€Ÿç”¨è€…'; break;
                    default: roleDisplay = 'ä½¿ç”¨è€…';
                }
                
                document.getElementById('userDisplay').textContent = user.email + ' (' + roleDisplay + ')';
                
                if (user.role === 'admin') {
                    document.getElementById('addPartBtn').style.display = 'inline-block';
                    document.getElementById('borrowRecordsBtn').style.display = 'inline-block';
                    document.getElementById('userMgmtBtn').style.display = 'inline-block';
                } else if (user.role === 'ra_staff') {
                    document.getElementById('addPartBtn').style.display = 'inline-block';
                    document.getElementById('borrowRecordsBtn').style.display = 'inline-block';
                    document.getElementById('userMgmtBtn').style.display = 'none';
                } else {
                    document.getElementById('addPartBtn').style.display = 'none';
                    document.getElementById('borrowRecordsBtn').style.display = 'none';
                    document.getElementById('userMgmtBtn').style.display = 'none';
                }
                
                showPage('searchPage');
            } else {
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        function showPage(pageId) {
            if (!currentUser) return;
            
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'searchPage') {
                updateTableHeader(); // ğŸ”¥ æ›´æ–°è¡¨æ ¼æ¨™é¡Œ
                loadParts();
            } else if (pageId === 'userManagementPage') {
                loadUsers();
            } else if (pageId === 'borrowRecordsPage') {
                loadBorrowRecords();
            }
        }

        // è¼‰å…¥é›¶ä»¶åˆ—è¡¨ - æ–°å¢å­˜æ”¾ä½ç½®æ¬„ä½
        function loadParts(searchKeyword = '', sortBy = 'model') {
            const tbody = document.getElementById('partsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // æ ¹æ“šç”¨æˆ¶æ¬Šé™æ±ºå®šç©ºåˆ—çš„åˆ—æ•¸
            const colSpan = currentUser && (currentUser.role === 'admin' || currentUser.role === 'ra_staff') ? '8' : '5';
            
            // æ ¹æ“šæ¬Šé™éæ¿¾é›¶ä»¶
            let visibleParts = parts.filter(part => {
                // ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰é›¶ä»¶
                if (currentUser.role === 'admin') {
                    return true;
                }
                // RAåŒä»å¯ä»¥çœ‹åˆ°ï¼š1.ééš±è—é›¶ä»¶ 2.è‡ªå·±å»ºç«‹çš„éš±è—é›¶ä»¶
                else if (currentUser.role === 'ra_staff') {
                    return !part.isHidden || part.createdBy === currentUser.email;
                }
                // DEMOå€Ÿç”¨è€…åªèƒ½çœ‹åˆ°ééš±è—é›¶ä»¶
                else {
                    return !part.isHidden;
                }
            });
            
            // æ ¹æ“šæœå°‹é—œéµå­—éæ¿¾
            if (searchKeyword) {
                visibleParts = visibleParts.filter(part => {
                    // ä¸å€åˆ†å¤§å°å¯«æœå°‹ï¼Œæª¢æŸ¥å‹è™Ÿæ˜¯å¦åŒ…å«é—œéµå­—
                    return part.model.toLowerCase().includes(searchKeyword);
                });
                console.log('æœå°‹çµæœæ•¸é‡:', visibleParts.length);
            }
            
            // æ ¹æ“šé¸æ“‡çš„æ–¹å¼æ’åº
            if (sortBy === 'model') {
                visibleParts.sort((a, b) => a.model.localeCompare(b.model));
            } else if (sortBy === 'status') {
                // ä¾ç‹€æ…‹æ’åºï¼šåœ¨åº« > å·²é ç´„/å€Ÿå‡º
                visibleParts.sort((a, b) => {
                    const today = new Date();
                    const aAvailable = getAvailableQuantityAtDate(a.id, today);
                    const bAvailable = getAvailableQuantityAtDate(b.id, today);
                    return bAvailable - aAvailable;
                });
            }
            
            if (visibleParts.length === 0) {
                const row = document.createElement('tr');
                let emptyMessage = searchKeyword ? 
                    'æ‰¾ä¸åˆ°ç¬¦åˆã€Œ' + searchKeyword + 'ã€çš„é›¶ä»¶è³‡æ–™' : 
                    'æ²’æœ‰å¯é¡¯ç¤ºçš„é›¶ä»¶è³‡æ–™';
                row.innerHTML = '<td colspan="' + colSpan + '" style="text-align: center; color: #6b7280; padding: 30px;">' + emptyMessage + '</td>';
                tbody.appendChild(row);
                return;
            }
            
            visibleParts.forEach(part => {
                const row = document.createElement('tr');
                
                // ä½¿ç”¨æ ¸å¿ƒå‡½æ•¸è¨ˆç®—ç•¶å‰å¯¦éš›å¯ç”¨æ•¸é‡
                const today = new Date();
                const currentAvailable = getAvailableQuantityAtDate(part.id, today);
                const currentUsed = part.quantity - currentAvailable;
                
                console.log('é›¶ä»¶', part.model, '- ç¸½åº«å­˜:', part.quantity, 'å·²ä½¿ç”¨:', currentUsed, 'å¯ç”¨:', currentAvailable);
                
                let actionCell = '';
                if (currentAvailable > 0) {
                    actionCell = '<button class="btn btn-primary" onclick="openBorrowModal(' + part.id + ')" style="margin-right: 5px; margin-bottom: 5px;">ç”³è«‹å€Ÿç”¨</button>';
                } else {
                    // ç•¶å‰ç„¡åº«å­˜æ™‚ï¼Œé¡¯ç¤ºé ç´„ç”³è«‹æŒ‰éˆ•
                    actionCell = '<button class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); color: white; margin-right: 5px; margin-bottom: 5px;" onclick="openBorrowModal(' + part.id + ', true)">é ç´„ç”³è«‹</button>';
                }
                
                // ğŸ”¥ æ–°å¢åº«å­˜èª¿æ•´åŠŸèƒ½
                let inventoryActionCell = '';
                if (currentUser) {
                    if (currentUser.role === 'admin') {
                        // ç®¡ç†å“¡å¯ä»¥èª¿æ•´æ‰€æœ‰é›¶ä»¶çš„åº«å­˜
                        inventoryActionCell = '<button class="btn btn-secondary" onclick="openInventoryModal(' + part.id + ')" style="padding: 8px 12px; font-size: 12px; margin-bottom: 5px;">èª¿æ•´åº«å­˜</button>';
                    } else if (currentUser.role === 'ra_staff' && part.createdBy === currentUser.email) {
                        // RAåŒä»åªèƒ½èª¿æ•´è‡ªå·±å»ºç«‹çš„é›¶ä»¶åº«å­˜
                        inventoryActionCell = '<button class="btn btn-secondary" onclick="openInventoryModal(' + part.id + ')" style="padding: 8px 12px; font-size: 12px; margin-bottom: 5px;">èª¿æ•´åº«å­˜</button>';
                    }
                }
                
                actionCell += inventoryActionCell;
                
                // é¡¯ç¤ºå¯¦éš›å¯ç”¨æ•¸é‡
                let quantityCell = currentAvailable.toString();
                if (currentUsed > 0) {
                    quantityCell += ' <span>(åŸå§‹: ' + part.quantity + ', å·²ç”¨: ' + currentUsed + ')</span>';
                }
                
                let statusCell = '<span class="status-badge ' + (currentAvailable > 0 ? 'status-available' : 'status-borrowed') + '">' + (currentAvailable > 0 ? 'åœ¨åº«' : 'å·²é ç´„/å€Ÿå‡º') + '</span>';
                
                // åŠ ä¸Šéš±è—æ¨™è¨˜
                if (part.isHidden) {
                    statusCell += ' <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; margin-left: 5px;">éš±è—</span>';
                }
                
                // ç…§ç‰‡é¡¯ç¤º
                let photoCell = '';
                if (part.photo) {
                    photoCell = '<img src="' + part.photo + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="showImageModal(\'' + part.photo + '\')">';
                } else {
                    photoCell = '<span>ç„¡ç…§ç‰‡</span>';
                }
                
                // ğŸ”¥ æ–°å¢å­˜æ”¾ä½ç½®ã€å»ºç«‹è€…å’Œå‚™è¨»æ¬„ä½
                let locationCreatorNotesCells = '';
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'ra_staff')) {
                    // å­˜æ”¾ä½ç½®æ¬„ä½
                    const locationCell = '<td>' + (part.location || 'æœªè¨­å®š') + '</td>';
                    // å»ºç«‹è€…æ¬„ä½
                    const creatorCell = '<td>' + (part.createdBy || 'æœªçŸ¥') + '</td>';
                    // å‚™è¨»æ¬„ä½
                    const notesCell = '<td>' + (part.notes || '-') + '</td>';
                    locationCreatorNotesCells = locationCell + creatorCell + notesCell;
                }
                
                row.innerHTML = '<td>' + part.model + '</td><td>' + quantityCell + '</td><td>' + statusCell + '</td><td>' + photoCell + '</td>' + locationCreatorNotesCells + '<td>' + actionCell + '</td>';
                tbody.appendChild(row);
            });
        }

        function searchParts() {
            const searchKeyword = document.getElementById('searchInput').value.trim().toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            
            console.log('åŸ·è¡Œæœå°‹ - é—œéµå­—:', searchKeyword, 'æ’åº:', sortBy);
            
            // é‡æ–°è¼‰å…¥é›¶ä»¶åˆ—è¡¨ï¼Œä¸¦åŠ å…¥æœå°‹éæ¿¾
            loadParts(searchKeyword, sortBy);
        }

        // æ–°å¢é›¶ä»¶
        function addPart() {
            const model = document.getElementById('partModel').value.trim();
            const quantity = parseInt(document.getElementById('partQuantity').value);
            const location = document.getElementById('partLocation').value.trim();
            const notes = document.getElementById('partNotes').value.trim();
            const isHidden = document.getElementById('partHidden').checked;
            const photoFile = document.getElementById('partPhoto').files[0];

            if (!model || !location) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            if (parts.find(p => p.model === model)) {
                alert('æ­¤å‹è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„å‹è™Ÿ');
                return;
            }

            // è™•ç†ç…§ç‰‡
            let photoDataUrl = null;
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoDataUrl = e.target.result;
                    savePartWithPhoto();
                };
                reader.readAsDataURL(photoFile);
            } else {
                savePartWithPhoto();
            }

            function savePartWithPhoto() {
                const newPart = {
                    id: Date.now(),
                    model: model,
                    quantity: quantity,
                    location: location,
                    notes: notes || '',
                    isHidden: isHidden,
                    photo: photoDataUrl,
                    status: 'åœ¨åº«',
                    createdAt: new Date(),
                    createdBy: currentUser.email
                };

                parts.push(newPart);
                alert('âœ… é›¶ä»¶å»ºç«‹æˆåŠŸï¼' + (isHidden ? '\n\næ³¨æ„ï¼šæ­¤é›¶ä»¶å·²è¨­ç‚ºéš±è—ï¼Œåªæœ‰æ‚¨å’Œç®¡ç†å“¡å¯ä»¥çœ‹åˆ°ã€‚' : ''));
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('partModel').value = '';
                document.getElementById('partQuantity').value = '1';
                document.getElementById('partLocation').value = '';
                document.getElementById('partNotes').value = '';
                document.getElementById('partHidden').checked = false;
                document.getElementById('partPhoto').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                
                loadParts();
            }
        }

        // åœ–ç‰‡é è¦½åŠŸèƒ½
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // ğŸ”¥ åº«å­˜èª¿æ•´åŠŸèƒ½
        
        // å‹•æ…‹ç”Ÿæˆè¡¨æ ¼æ¨™é¡Œ
        function updateTableHeader() {
            const headerRow = document.getElementById('partsTableHeader');
            if (!headerRow) return;
            
            let headerHtml = '<th style="width: 12%;">å‹è™Ÿ</th><th style="width: 15%;">åœ¨åº«æ•¸é‡</th><th style="width: 12%;">åœ¨åº«ç‹€æ…‹</th><th style="width: 10%;">ç…§ç‰‡</th>';
            
            // æ ¹æ“šç”¨æˆ¶æ¬Šé™é¡¯ç¤ºå­˜æ”¾ä½ç½®å’Œå»ºç«‹è€…æ¬„ä½
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'ra_staff')) {
                headerHtml += '<th style="width: 18%;">å­˜æ”¾ä½ç½®</th>';
                headerHtml += '<th style="width: 12%;">å»ºç«‹è€…</th>';
                headerHtml += '<th style="width: 15%;">å‚™è¨»</th>';
            }
            
            headerHtml += '<th style="width: 21%;">æ“ä½œ</th>';
            headerRow.innerHTML = headerHtml;
        }

        // é–‹å•Ÿåº«å­˜èª¿æ•´å½ˆçª—
        function openInventoryModal(partId) {
            currentInventoryPart = parts.find(p => p.id === partId);
            if (!currentInventoryPart) return;

            console.log('=== é–‹å•Ÿåº«å­˜èª¿æ•´å½ˆçª— ===');
            console.log('é›¶ä»¶ID:', partId, 'é›¶ä»¶è³‡æ–™:', currentInventoryPart);

            // æª¢æŸ¥æ¬Šé™
            if (currentUser.role === 'ra_staff' && currentInventoryPart.createdBy !== currentUser.email) {
                alert('æ‚¨åªèƒ½èª¿æ•´è‡ªå·±å»ºç«‹çš„é›¶ä»¶åº«å­˜');
                return;
            }

            document.getElementById('inventoryModal').style.display = 'block';
            document.getElementById('inventoryPartModel').value = currentInventoryPart.model;
            document.getElementById('currentInventoryQuantity').value = currentInventoryPart.quantity;
            document.getElementById('newInventoryQuantity').value = currentInventoryPart.quantity;
            document.getElementById('inventoryReason').value = '';
            document.getElementById('inventoryWarning').style.display = 'none';

            // ç¶å®šæ•¸é‡è®Šæ›´äº‹ä»¶
            document.getElementById('newInventoryQuantity').addEventListener('input', checkInventoryImpact);
        }

        // æª¢æŸ¥åº«å­˜èª¿æ•´çš„å½±éŸ¿
        function checkInventoryImpact() {
            if (!currentInventoryPart) return;

            const newQuantity = parseInt(document.getElementById('newInventoryQuantity').value) || 0;
            const currentQuantity = currentInventoryPart.quantity;
            const warningDiv = document.getElementById('inventoryWarning');
            const detailsDiv = document.getElementById('inventoryWarningDetails');

            console.log('æª¢æŸ¥åº«å­˜èª¿æ•´å½±éŸ¿ - ç›®å‰:', currentQuantity, 'æ–°çš„:', newQuantity);

            if (newQuantity < currentQuantity) {
                // æ¸›å°‘åº«å­˜ï¼Œæª¢æŸ¥æ˜¯å¦æœƒå½±éŸ¿ç¾æœ‰é ç´„å’Œå€Ÿå‡º
                const today = new Date();
                const currentUsed = currentQuantity - getAvailableQuantityAtDate(currentInventoryPart.id, today);
                
                console.log('ç›®å‰å·²ä½¿ç”¨æ•¸é‡:', currentUsed, 'æ–°åº«å­˜:', newQuantity);

                if (newQuantity < currentUsed) {
                    // æ–°åº«å­˜å°æ–¼å·²ä½¿ç”¨æ•¸é‡ï¼Œæœƒé€ æˆå•é¡Œ
                    warningDiv.style.display = 'block';
                    let warningText = 'æ–°çš„åº«å­˜æ•¸é‡ (' + newQuantity + ') å°æ–¼ç›®å‰å·²ä½¿ç”¨æ•¸é‡ (' + currentUsed + ')ï¼<br><br>';
                    warningText += '<strong>é€™å°‡å½±éŸ¿ä»¥ä¸‹è¨˜éŒ„ï¼š</strong><br>';

                    // åˆ†æå—å½±éŸ¿çš„è¨˜éŒ„
                    let affectedReservations = 0;
                    let affectedBorrows = 0;

                    reservations.forEach(reservation => {
                        if (reservation.partId === currentInventoryPart.id && reservation.status === RESERVATION_STATUS.CONFIRMED) {
                            const startTime = new Date(reservation.startDate).getTime();
                            const endTime = new Date(reservation.endDate).getTime();
                            const todayTime = today.getTime();

                            if (startTime <= todayTime && endTime >= todayTime) {
                                affectedReservations++;
                            }
                        }
                    });

                    borrowRecords.forEach(record => {
                        if (record.partId === currentInventoryPart.id && record.status === 'å€Ÿå‡ºä¸­') {
                            affectedBorrows++;
                        }
                    });

                    if (affectedReservations > 0) {
                        warningText += 'â€¢ ' + affectedReservations + ' å€‹é€²è¡Œä¸­çš„é ç´„<br>';
                    }
                    if (affectedBorrows > 0) {
                        warningText += 'â€¢ ' + affectedBorrows + ' å€‹å€Ÿå‡ºä¸­çš„è¨˜éŒ„<br>';
                    }

                    warningText += '<br><strong>å»ºè­°ï¼š</strong>è«‹å…ˆè™•ç†ç›¸é—œè¨˜éŒ„ï¼Œæˆ–å¢åŠ åº«å­˜æ•¸é‡ã€‚';
                    detailsDiv.innerHTML = warningText;
                } else {
                    warningDiv.style.display = 'none';
                }
            } else {
                warningDiv.style.display = 'none';
            }
        }

        // åŸ·è¡Œåº«å­˜èª¿æ•´
        function updateInventory() {
            if (!currentInventoryPart) return;

            const newQuantity = parseInt(document.getElementById('newInventoryQuantity').value);
            const reason = document.getElementById('inventoryReason').value.trim();

            if (isNaN(newQuantity) || newQuantity < 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº«å­˜æ•¸é‡ï¼ˆä¸èƒ½å°æ–¼0ï¼‰');
                return;
            }

            if (!reason) {
                alert('è«‹è¼¸å…¥èª¿æ•´åŸå› ');
                return;
            }

            const oldQuantity = currentInventoryPart.quantity;

            // æœ€çµ‚ç¢ºèª
            if (newQuantity !== oldQuantity) {
                const action = newQuantity > oldQuantity ? 'å¢åŠ ' : 'æ¸›å°‘';
                const diff = Math.abs(newQuantity - oldQuantity);
                
                if (!confirm('ç¢ºèªè¦å°‡ ' + currentInventoryPart.model + ' çš„åº«å­˜å¾ ' + oldQuantity + ' ' + action + ' ' + diff + ' å€‹åˆ° ' + newQuantity + ' å€‹å—ï¼Ÿ')) {
                    return;
                }

                // åŸ·è¡Œèª¿æ•´
                currentInventoryPart.quantity = newQuantity;

                // è¨˜éŒ„èª¿æ•´æ­·å²
                const log = {
                    id: Date.now(),
                    partId: currentInventoryPart.id,
                    partModel: currentInventoryPart.model,
                    oldQuantity: oldQuantity,
                    newQuantity: newQuantity,
                    difference: newQuantity - oldQuantity,
                    reason: reason,
                    adjustedBy: currentUser.email,
                    adjustedAt: new Date()
                };
                inventoryLogs.push(log);

                console.log('åº«å­˜èª¿æ•´å®Œæˆ:', log);
                alert('âœ… åº«å­˜èª¿æ•´æˆåŠŸï¼\n\né›¶ä»¶å‹è™Ÿï¼š' + currentInventoryPart.model + '\nåŸåº«å­˜ï¼š' + oldQuantity + '\næ–°åº«å­˜ï¼š' + newQuantity + '\nèª¿æ•´æ•¸é‡ï¼š' + (newQuantity > oldQuantity ? '+' : '') + (newQuantity - oldQuantity));

                closeInventoryModal();
                loadParts();
            } else {
                alert('åº«å­˜æ•¸é‡æ²’æœ‰è®Šæ›´');
            }
        }

        // é—œé–‰åº«å­˜èª¿æ•´å½ˆçª—
        function closeInventoryModal() {
            document.getElementById('inventoryModal').style.display = 'none';
            document.getElementById('inventoryPartModel').value = '';
            document.getElementById('currentInventoryQuantity').value = '';
            document.getElementById('newInventoryQuantity').value = '';
            document.getElementById('inventoryReason').value = '';
            document.getElementById('inventoryWarning').style.display = 'none';
            
            // ç§»é™¤äº‹ä»¶ç›£è½å™¨
            const quantityInput = document.getElementById('newInventoryQuantity');
            if (quantityInput) {
                const newInput = quantityInput.cloneNode(true);
                quantityInput.parentNode.replaceChild(newInput, quantityInput);
            }
            
            currentInventoryPart = null;
        }
        function checkReservationConflict(partId, startDate, endDate, requestQty) {
            console.log('=== é–‹å§‹è¡çªæª¢æŸ¥ ===');
            console.log('é›¶ä»¶ID:', partId, 'é–‹å§‹:', startDate.toLocaleDateString(), 'çµæŸ:', endDate.toLocaleDateString(), 'ç”³è«‹æ•¸é‡:', requestQty);
            
            const part = parts.find(p => p.id === partId);
            if (!part) {
                console.log('æ‰¾ä¸åˆ°é›¶ä»¶');
                return { hasConflict: true, conflicts: [] };
            }
            
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            const conflicts = [];
            
            console.log('é›¶ä»¶ç¸½åº«å­˜:', part.quantity);
            
            while (currentDate <= end) {
                let totalUsed = 0;
                const currentTime = currentDate.getTime(); // ä½¿ç”¨æ™‚é–“æˆ³æ¯”è¼ƒ
                
                console.log('æª¢æŸ¥æ—¥æœŸ:', currentDate.toLocaleDateString(), 'æ™‚é–“æˆ³:', currentTime);
                
                // è¨ˆç®—è©²æ—¥æœŸæ‰€æœ‰çš„ä½¿ç”¨é‡
                // 1. ç¾æœ‰å€Ÿå‡ºè¨˜éŒ„
                borrowRecords.forEach(record => {
                    if (record.partId === partId && record.status === 'å€Ÿå‡ºä¸­') {
                        const recordStartTime = new Date(record.borrowTime).getTime();
                        const recordEndTime = record.borrowPeriod ? new Date(record.borrowPeriod).getTime() : null;
                        
                        if (recordStartTime <= currentTime && (!recordEndTime || recordEndTime >= currentTime)) {
                            totalUsed += (record.quantity || 1);
                            console.log('  å€Ÿå‡ºè¨˜éŒ„ä½”ç”¨:', record.quantity || 1, 'å€Ÿç”¨äºº:', record.borrowerName);
                        }
                    }
                });
                
                // 2. ç¾æœ‰é ç´„è¨˜éŒ„
                reservations.forEach(reservation => {
                    if (reservation.partId === partId && reservation.status === RESERVATION_STATUS.CONFIRMED) {
                        const reservationStartTime = new Date(reservation.startDate).getTime();
                        const reservationEndTime = new Date(reservation.endDate).getTime();
                        
                        if (reservationStartTime <= currentTime && reservationEndTime >= currentTime) {
                            totalUsed += reservation.quantity;
                            console.log('  é ç´„è¨˜éŒ„ä½”ç”¨:', reservation.quantity, 'é ç´„äºº:', reservation.borrowerName);
                        }
                    }
                });
                
                // 3. åŠ ä¸Šé€™æ¬¡çš„ç”³è«‹æ•¸é‡
                const totalNeeded = totalUsed + requestQty;
                
                console.log('  å·²ä½¿ç”¨:', totalUsed, '+ ç”³è«‹:', requestQty, '= ç¸½éœ€æ±‚:', totalNeeded, 'ç¸½åº«å­˜:', part.quantity);
                
                if (totalNeeded > part.quantity) {
                    console.log('  âŒ ç™¼ç¾è¡çªï¼è¶…å‡º:', totalNeeded - part.quantity);
                    conflicts.push({
                        date: new Date(currentDate),
                        currentUsed: totalUsed,
                        requestQty: requestQty,
                        totalNeeded: totalNeeded,
                        totalCapacity: part.quantity,
                        shortfall: totalNeeded - part.quantity
                    });
                } else {
                    console.log('  âœ… æ­¤æ—¥æœŸç„¡è¡çª');
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('=== è¡çªæª¢æŸ¥å®Œæˆï¼Œç¸½è¡çªå¤©æ•¸:', conflicts.length, '===');
            
            return {
                hasConflict: conflicts.length > 0,
                conflicts: conflicts
            };
        }

        // å‹•æ…‹æ›´æ–°æœ€å¤§å¯ç”³è«‹æ•¸é‡ - é‡æ–°è¨­è¨ˆ
        function updateMaxQuantity(startDate, endDate) {
            if (!currentBorrowingPart || !startDate || !endDate) {
                console.log('åƒæ•¸ä¸å®Œæ•´ï¼Œè·³éæ›´æ–°');
                return;
            }
            
            let minAvailable = currentBorrowingPart.quantity;
            let criticalDate = null;
            let criticalDetails = [];
            
            console.log('=== è¨ˆç®—æœŸé–“å…§æœ€å°å¯ç”¨åº«å­˜ ===');
            console.log('é›¶ä»¶:', currentBorrowingPart.model, 'ç¸½åº«å­˜:', currentBorrowingPart.quantity);
            console.log('ç”³è«‹æœŸé–“:', startDate.toLocaleDateString(), '~', endDate.toLocaleDateString());
            
            // æª¢æŸ¥ç¾æœ‰çš„é ç´„å’Œå€Ÿå‡ºè¨˜éŒ„
            console.log('ç¾æœ‰é ç´„è¨˜éŒ„:', reservations.filter(r => r.partId === currentBorrowingPart.id));
            console.log('ç¾æœ‰å€Ÿå‡ºè¨˜éŒ„:', borrowRecords.filter(r => r.partId === currentBorrowingPart.id));
            
            // é€æ—¥æª¢æŸ¥å¯ç”¨æ•¸é‡ï¼Œæ‰¾å‡ºæœ€å°å€¼å’Œé—œéµè¡çªé»
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            while (currentDate <= end) {
                const availableOnDate = getAvailableQuantityAtDate(currentBorrowingPart.id, currentDate);
                
                console.log('æ—¥æœŸ:', currentDate.toLocaleDateString(), 'å¯ç”¨æ•¸é‡:', availableOnDate);
                
                if (availableOnDate < minAvailable) {
                    minAvailable = availableOnDate;
                    criticalDate = new Date(currentDate);
                    
                    // åˆ†æé€™å€‹æ—¥æœŸçš„è©³ç´°ä½¿ç”¨æƒ…æ³
                    criticalDetails = analyzeUsageOnDate(currentBorrowingPart.id, currentDate);
                    console.log('æ›´æ–°æœ€å°å¯ç”¨æ•¸é‡:', minAvailable, 'é—œéµæ—¥æœŸ:', criticalDate.toLocaleDateString());
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('=== æœ€çµ‚çµæœ ===');
            console.log('æœŸé–“å…§æœ€å°å¯ç”¨æ•¸é‡:', minAvailable);
            console.log('é—œéµè¡çªæ—¥æœŸ:', criticalDate ? criticalDate.toLocaleDateString() : 'ç„¡');
            
            // æ›´æ–°æ•¸é‡è¼¸å…¥æ¡†çš„æœ€å¤§å€¼
            const quantityInput = document.getElementById('borrowQuantity');
            if (quantityInput) {
                const oldMax = quantityInput.max;
                quantityInput.max = minAvailable;
                console.log('æ›´æ–°æ•¸é‡è¼¸å…¥æ¡†æœ€å¤§å€¼:', oldMax, '->', minAvailable);
                
                // å¦‚æœç•¶å‰è¼¸å…¥çš„æ•¸é‡è¶…éæœ€å¤§å¯ç”¨æ•¸é‡ï¼Œè‡ªå‹•èª¿æ•´
                const currentValue = parseInt(quantityInput.value);
                if (currentValue > minAvailable) {
                    quantityInput.value = minAvailable;
                    console.log('è‡ªå‹•èª¿æ•´ç”³è«‹æ•¸é‡:', currentValue, '->', minAvailable);
                }
            }
            
            // åœ¨é é¢ä¸Šé¡¯ç¤ºæœ€å¤§å¯ç”³è«‹æ•¸é‡æç¤º
            updateQuantityHint(minAvailable, criticalDate, criticalDetails);
        }

        // åˆ†æç‰¹å®šæ—¥æœŸçš„ä½¿ç”¨æƒ…æ³
        function analyzeUsageOnDate(partId, targetDate) {
            const details = [];
            const targetDateStr = targetDate.toDateString();
            
            // åˆ†æå€Ÿå‡ºè¨˜éŒ„
            borrowRecords.forEach(record => {
                if (record.partId === partId && record.status === 'å€Ÿå‡ºä¸­') {
                    const recordStartDate = new Date(record.borrowTime).toDateString();
                    const recordEndDate = record.borrowPeriod ? new Date(record.borrowPeriod).toDateString() : null;
                    
                    if (recordStartDate <= targetDateStr && (!recordEndDate || recordEndDate >= targetDateStr)) {
                        details.push({
                            type: 'å€Ÿå‡º',
                            user: record.borrowerName,
                            quantity: record.quantity || 1,
                            period: new Date(record.borrowTime).toLocaleDateString() + ' ~ ' + 
                                   (record.borrowPeriod ? new Date(record.borrowPeriod).toLocaleDateString() : 'æœªè¨­å®š')
                        });
                    }
                }
            });
            
            // åˆ†æé ç´„è¨˜éŒ„
            reservations.forEach(reservation => {
                if (reservation.partId === partId && reservation.status === RESERVATION_STATUS.CONFIRMED) {
                    const reservationStartDate = new Date(reservation.startDate).toDateString();
                    const reservationEndDate = new Date(reservation.endDate).toDateString();
                    
                    if (reservationStartDate <= targetDateStr && reservationEndDate >= targetDateStr) {
                        details.push({
                            type: 'é ç´„',
                            user: reservation.borrowerName,
                            quantity: reservation.quantity,
                            period: new Date(reservation.startDate).toLocaleDateString() + ' ~ ' + 
                                   new Date(reservation.endDate).toLocaleDateString()
                        });
                    }
                }
            });
            
            return details;
        }

        // æ›´æ–°æ•¸é‡æç¤º - å¢å¼·ç‰ˆ
        function updateQuantityHint(maxQuantity, criticalDate, criticalDetails) {
            const quantityInput = document.getElementById('borrowQuantity');
            const existingHint = document.getElementById('quantityHint');
            
            // ç§»é™¤èˆŠçš„æç¤º
            if (existingHint) {
                existingHint.remove();
            }
            
            // æ·»åŠ æ–°çš„æç¤º
            const hint = document.createElement('div');
            hint.id = 'quantityHint';
            hint.style.fontSize = '14px';
            hint.style.marginTop = '5px';
            hint.style.padding = '10px';
            hint.style.borderRadius = '8px';
            hint.style.border = '1px solid';
            
            if (maxQuantity > 0) {
                hint.style.color = '#10b981';
                hint.style.backgroundColor = '#d1fae5';
                hint.style.borderColor = '#10b981';
                
                let hintText = 'âœ… æ­¤æœŸé–“æœ€å¤šå¯ç”³è«‹ï¼š<strong>' + maxQuantity + ' å€‹</strong>';
                
                if (criticalDate && criticalDetails.length > 0) {
                    hintText += '<br><br>ğŸ“… é™åˆ¶åŸå› ï¼ˆ' + criticalDate.toLocaleDateString() + 'ï¼‰ï¼š<br>';
                    criticalDetails.forEach(detail => {
                        hintText += 'â€¢ ' + detail.type + 'ï¼š' + detail.user + ' (' + detail.quantity + 'å€‹) ' + detail.period + '<br>';
                    });
                }
                
                hint.innerHTML = hintText;
            } else {
                hint.style.color = '#dc2626';
                hint.style.backgroundColor = '#fecaca';
                hint.style.borderColor = '#dc2626';
                hint.innerHTML = 'âŒ æ­¤æœŸé–“ç„¡å¯ç”¨åº«å­˜';
            }
            
            quantityInput.parentNode.appendChild(hint);
        }

        function checkConflictOnChange() {
            const startDateInput = document.getElementById('borrowStartDate');
            const endDateInput = document.getElementById('borrowEndDate');
            const quantityInput = document.getElementById('borrowQuantity');
            const submitButton = document.querySelector('#borrowModal .btn-primary');
            
            if (!startDateInput || !endDateInput || !quantityInput || !currentBorrowingPart) {
                console.log('å…ƒç´ æˆ–é›¶ä»¶è³‡æ–™ä¸å­˜åœ¨ï¼Œè·³éæª¢æŸ¥');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (!startDateInput.value || !endDateInput.value) {
                console.log('æ—¥æœŸæœªé¸æ“‡ï¼Œè·³éæª¢æŸ¥');
                if (submitButton) submitButton.style.display = 'inline-block'; // é¡¯ç¤ºæŒ‰éˆ•
                return;
            }
            
            console.log('=== é–‹å§‹æª¢æŸ¥è¡çª ===');
            console.log('é›¶ä»¶:', currentBorrowingPart.model);
            console.log('é–‹å§‹æ—¥æœŸ:', startDate.toLocaleDateString());
            console.log('çµæŸæ—¥æœŸ:', endDate.toLocaleDateString());
            console.log('ç”³è«‹æ•¸é‡:', quantity);
            
            // æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
            if (endDate <= startDate) {
                console.log('çµæŸæ—¥æœŸå¿…é ˆæ™šæ–¼é–‹å§‹æ—¥æœŸ');
                if (submitButton) submitButton.style.display = 'none'; // éš±è—æŒ‰éˆ•
                return;
            }
            
            // æ›´æ–°æœ€å¤§å¯ç”³è«‹æ•¸é‡
            updateMaxQuantity(startDate, endDate);
            
            // æª¢æŸ¥è¡çª
            const conflictResult = checkReservationConflict(currentBorrowingPart.id, startDate, endDate, quantity);
            const warningDiv = document.getElementById('conflictWarning');
            const detailsDiv = document.getElementById('conflictDetails');
            
            if (conflictResult.hasConflict) {
                console.log('ç™¼ç¾è¡çªï¼Œé¡¯ç¤ºè­¦å‘Šä¸¦éš±è—ç”³è«‹æŒ‰éˆ•');
                warningDiv.style.display = 'block';
                
                // ğŸ”¥ éš±è—ç¢ºèªç”³è«‹æŒ‰éˆ•
                if (submitButton) {
                    submitButton.style.display = 'none';
                    console.log('å·²éš±è—ç¢ºèªç”³è«‹æŒ‰éˆ•');
                }
                
                let details = 'ç”³è«‹æ•¸é‡ï¼š' + quantity + '<br>';
                details += 'é›¶ä»¶ç¸½åº«å­˜ï¼š' + currentBorrowingPart.quantity + '<br><br>';
                details += '<strong>è¡çªè©³æƒ…ï¼š</strong><br>';
                
                conflictResult.conflicts.slice(0, 5).forEach((c, index) => {
                    details += (index + 1) + '. ' + c.date.toLocaleDateString() + 'ï¼š<br>';
                    details += '&nbsp;&nbsp;&nbsp;å·²ä½¿ç”¨ï¼š' + c.currentUsed + ' + ç”³è«‹ï¼š' + c.requestQty + ' = ' + c.totalNeeded + '<br>';
                    details += '&nbsp;&nbsp;&nbsp;ç¸½åº«å­˜ï¼š' + c.totalCapacity + 'ï¼Œ<span style="color: #dc2626; font-weight: bold;">è¶…å‡ºï¼š' + c.shortfall + '</span><br><br>';
                });
                
                if (conflictResult.conflicts.length > 5) {
                    details += '... é‚„æœ‰ ' + (conflictResult.conflicts.length - 5) + ' å€‹è¡çªæ—¥æœŸ<br><br>';
                }
                
                details += '<strong style="color: #dc2626;">æ­¤ç”³è«‹å°‡è¢«ç³»çµ±æ‹’çµ•ï¼</strong><br>';
                details += 'è«‹èª¿æ•´å€Ÿç”¨æ—¥æœŸæˆ–æ¸›å°‘å€Ÿç”¨æ•¸é‡ã€‚';
                
                detailsDiv.innerHTML = details;
            } else {
                console.log('ç„¡è¡çªï¼Œéš±è—è­¦å‘Šä¸¦é¡¯ç¤ºç”³è«‹æŒ‰éˆ•');
                warningDiv.style.display = 'none';
                
                // ğŸ”¥ é¡¯ç¤ºç¢ºèªç”³è«‹æŒ‰éˆ•
                if (submitButton) {
                    submitButton.style.display = 'inline-block';
                    console.log('å·²é¡¯ç¤ºç¢ºèªç”³è«‹æŒ‰éˆ•');
                }
            }
        }

        // é–‹å•Ÿå€Ÿç”¨ç”³è«‹å½ˆçª—
        function openBorrowModal(partId, isReservation = false) {
            currentBorrowingPart = parts.find(p => p.id === partId);
            if (!currentBorrowingPart) return;

            console.log('=== é–‹å•Ÿå€Ÿç”¨ç”³è«‹å½ˆçª— ===');
            console.log('é›¶ä»¶ID:', partId, 'é›¶ä»¶è³‡æ–™:', currentBorrowingPart);
            console.log('æ˜¯å¦ç‚ºé ç´„ç”³è«‹:', isReservation);

            document.getElementById('borrowModal').style.display = 'block';
            
            // æ ¹æ“šæ˜¯å¦ç‚ºé ç´„ç”³è«‹ï¼Œèª¿æ•´å½ˆçª—æ¨™é¡Œ
            const modalTitle = document.querySelector('#borrowModal h3');
            if (modalTitle) {
                modalTitle.textContent = isReservation ? 'é ç´„ç”³è«‹' : 'ç”³è«‹å€Ÿç”¨';
            }
            
            // å¦‚æœæ˜¯é ç´„ç”³è«‹ï¼ŒåŠ å…¥æç¤ºè¨Šæ¯
            const modalBody = document.querySelector('#borrowModal .modal-body');
            const existingNotice = document.getElementById('reservationNotice');
            if (existingNotice) {
                existingNotice.remove();
            }
            
            if (isReservation) {
                const notice = document.createElement('div');
                notice.id = 'reservationNotice';
                notice.style.cssText = 'background: #fef3c7; color: #92400e; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fbbf24;';
                notice.innerHTML = '<strong>ğŸ“… é ç´„ç”³è«‹èªªæ˜ï¼š</strong><br>ç›®å‰æ­¤é›¶ä»¶ç„¡åº«å­˜ï¼Œä½†æ‚¨å¯ä»¥é ç´„æœªä¾†çš„ä½¿ç”¨æ™‚æ®µã€‚ç³»çµ±æœƒæª¢æŸ¥æ‚¨é¸æ“‡çš„æœŸé–“å…§æ˜¯å¦æœ‰å¯ç”¨åº«å­˜ã€‚';
                modalBody.insertBefore(notice, modalBody.firstChild.nextSibling);
            }
            
            // è‡ªå‹•å¸¶å…¥ç•¶å‰ä½¿ç”¨è€…è³‡æ–™
            if (currentUser) {
                // å¦‚æœæ˜¯é è¨­æ¸¬è©¦å¸³è™Ÿï¼Œä½¿ç”¨é è¨­å€¼
                if (currentUser.email === '11' || currentUser.email === '22' || currentUser.email === '33') {
                    document.getElementById('borrowerName').value = currentUser.email;
                    document.getElementById('borrowerEmail').value = currentUser.email + '@demo.com';
                    document.getElementById('borrowerPhone').value = '0912-345-678';
                } else {
                    // ä½¿ç”¨çœŸå¯¦ä½¿ç”¨è€…è³‡æ–™
                    document.getElementById('borrowerName').value = currentUser.name || '';
                    document.getElementById('borrowerEmail').value = currentUser.email || '';
                    document.getElementById('borrowerPhone').value = currentUser.phone || '';
                }
                
                // è¨­å®šæ¬„ä½ç‚ºå”¯è®€
                document.getElementById('borrowerName').readOnly = true;
                document.getElementById('borrowerEmail').readOnly = true;
                document.getElementById('borrowerPhone').readOnly = true;
                
                // èª¿æ•´æ¬„ä½æ¨£å¼ä»¥é¡¯ç¤ºç‚ºå”¯è®€
                document.getElementById('borrowerName').style.backgroundColor = '#f3f4f6';
                document.getElementById('borrowerEmail').style.backgroundColor = '#f3f4f6';
                document.getElementById('borrowerPhone').style.backgroundColor = '#f3f4f6';
            }
            
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('borrowStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('borrowEndDate').value = tomorrow.toISOString().split('T')[0];
            
            // åˆå§‹è¨­å®šæœ€å¤§å¯ç”³è«‹æ•¸é‡
            const initialAvailable = getAvailableQuantityAtDate(partId, today);
            console.log('ä»Šå¤©å¯ç”¨æ•¸é‡:', initialAvailable);
            
            document.getElementById('borrowQuantity').max = initialAvailable;
            document.getElementById('borrowQuantity').value = Math.min(1, initialAvailable);
            
            // ğŸ”¥ ç¢ºä¿ç¢ºèªç”³è«‹æŒ‰éˆ•åˆå§‹ç‹€æ…‹ç‚ºé¡¯ç¤º
            const submitButton = document.querySelector('#borrowModal .btn-primary');
            if (submitButton) {
                submitButton.style.display = 'inline-block';
                console.log('åˆå§‹åŒ–ï¼šé¡¯ç¤ºç¢ºèªç”³è«‹æŒ‰éˆ•');
            }
            
            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
            const startDateInput = document.getElementById('borrowStartDate');
            const endDateInput = document.getElementById('borrowEndDate');
            const quantityInput = document.getElementById('borrowQuantity');
            
            // å…‹éš†å…ƒç´ ä¾†ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›£è½å™¨
            const newStartDateInput = startDateInput.cloneNode(true);
            const newEndDateInput = endDateInput.cloneNode(true);
            const newQuantityInput = quantityInput.cloneNode(true);
            
            startDateInput.parentNode.replaceChild(newStartDateInput, startDateInput);
            endDateInput.parentNode.replaceChild(newEndDateInput, endDateInput);
            quantityInput.parentNode.replaceChild(newQuantityInput, quantityInput);
            
            // ç¶å®šæ–°çš„äº‹ä»¶ç›£è½å™¨
            document.getElementById('borrowStartDate').addEventListener('change', function() {
                console.log('é–‹å§‹æ—¥æœŸè®Šæ›´');
                checkConflictOnChange();
            });
            document.getElementById('borrowEndDate').addEventListener('change', function() {
                console.log('çµæŸæ—¥æœŸè®Šæ›´');
                checkConflictOnChange();
            });
            document.getElementById('borrowQuantity').addEventListener('input', function() {
                console.log('æ•¸é‡è®Šæ›´');
                checkConflictOnChange();
            });
            
            // ç«‹å³åŸ·è¡Œåˆå§‹æª¢æŸ¥
            console.log('åŸ·è¡Œåˆå§‹æª¢æŸ¥');
            setTimeout(function() {
                checkConflictOnChange();
            }, 200);
        }

        // æäº¤å€Ÿç”¨ç”³è«‹ - ä¿®æ­£ ID åŒ¹é…å•é¡Œ
        function submitBorrow() {
            const borrowerName = document.getElementById('borrowerName').value.trim();
            const borrowerEmail = document.getElementById('borrowerEmail').value.trim();
            const borrowerPhone = document.getElementById('borrowerPhone').value.trim();
            const startDate = document.getElementById('borrowStartDate').value;
            const endDate = document.getElementById('borrowEndDate').value;
            const quantity = parseInt(document.getElementById('borrowQuantity').value);
            const description = document.getElementById('borrowDescription').value.trim();

            if (!borrowerName || !borrowerEmail || !borrowerPhone || !startDate || !endDate || !quantity || !description) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
                return;
            }

            if (new Date(endDate) <= new Date(startDate)) {
                alert('çµæŸæ—¥æœŸå¿…é ˆæ™šæ–¼é–‹å§‹æ—¥æœŸ');
                return;
            }

            console.log('=== æäº¤å€Ÿç”¨ç”³è«‹å‰çš„å¼·åˆ¶æª¢æŸ¥ ===');
            console.log('é›¶ä»¶:', currentBorrowingPart.model, 'é›¶ä»¶ID:', currentBorrowingPart.id, 'ç”³è«‹äºº:', borrowerName, 'æ•¸é‡:', quantity);
            console.log('æœŸé–“:', startDate, '~', endDate);

            // ğŸ”¥ å¼·åˆ¶åŸ·è¡Œæœ€çµ‚è¡çªæª¢æŸ¥ - ç„¡æ³•ç¹é
            const conflictResult = checkReservationConflict(currentBorrowingPart.id, new Date(startDate), new Date(endDate), quantity);
            
            console.log('=== æœ€çµ‚è¡çªæª¢æŸ¥çµæœ ===');
            console.log('æœ‰è¡çª:', conflictResult.hasConflict);
            console.log('è¡çªå¤©æ•¸:', conflictResult.conflicts.length);
            
            if (conflictResult.hasConflict) {
                console.log('ğŸš« ç”³è«‹è¢«æ‹’çµ• - åº«å­˜è¡çª');
                
                let alertMessage = 'âŒ ç”³è«‹å¤±æ•—ï¼æœŸé–“å…§åº«å­˜ä¸è¶³ã€‚\n\n';
                alertMessage += 'ğŸ” è¡çªåˆ†æï¼š\n';
                alertMessage += 'â€¢ ç”³è«‹æ•¸é‡ï¼š' + quantity + '\n';
                alertMessage += 'â€¢ é›¶ä»¶ç¸½åº«å­˜ï¼š' + currentBorrowingPart.quantity + '\n\n';
                alertMessage += 'ğŸ“… è¡çªè©³æƒ…ï¼š\n';
                
                // é¡¯ç¤ºå‰3å€‹è¡çªæ—¥æœŸçš„è©³ç´°è³‡è¨Š
                conflictResult.conflicts.slice(0, 3).forEach((c, index) => {
                    alertMessage += (index + 1) + '. ' + c.date.toLocaleDateString() + 'ï¼š\n';
                    alertMessage += '   å·²ä½¿ç”¨ï¼š' + c.currentUsed + ' + ç”³è«‹ï¼š' + c.requestQty + ' = ' + c.totalNeeded + '\n';
                    alertMessage += '   ç¸½åº«å­˜ï¼š' + c.totalCapacity + 'ï¼Œè¶…å‡ºï¼š' + c.shortfall + '\n\n';
                });
                
                if (conflictResult.conflicts.length > 3) {
                    alertMessage += '... é‚„æœ‰ ' + (conflictResult.conflicts.length - 3) + ' å€‹è¡çªæ—¥æœŸ\n\n';
                }
                
                alertMessage += 'ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š\n';
                alertMessage += 'â€¢ é¸æ“‡å…¶ä»–å¯ç”¨æ—¥æœŸ\n';
                alertMessage += 'â€¢ æ¸›å°‘å€Ÿç”¨æ•¸é‡\n';
                alertMessage += 'â€¢ åˆ†æ®µç”³è«‹ï¼ˆé¿é–‹è¡çªæœŸé–“ï¼‰\n';
                alertMessage += 'â€¢ è¯çµ¡ç®¡ç†å“¡å”èª¿';
                
                alert(alertMessage);
                return; // ğŸš« å¼·åˆ¶åœæ­¢ï¼Œä¸å…è¨±æäº¤
            }

            // âœ… ç„¡è¡çªï¼Œå¯ä»¥ç¹¼çºŒæäº¤
            console.log('âœ… ç„¡è¡çªï¼Œå…è¨±æäº¤ç”³è«‹');

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const start = new Date(startDate);
            start.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((start.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                // é ç´„ç”³è«‹ - ğŸ”¥ ä¿®æ­£ï¼šç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ partId
                const reservation = {
                    id: Date.now(),
                    partId: currentBorrowingPart.id, // ğŸ”¥ é‡è¦ï¼šä½¿ç”¨æ­£ç¢ºçš„é›¶ä»¶ID
                    partModel: currentBorrowingPart.model,
                    borrowerName: borrowerName,
                    borrowerEmail: borrowerEmail,
                    borrowerPhone: borrowerPhone,
                    startDate: startDate,
                    endDate: endDate,
                    quantity: quantity,
                    status: RESERVATION_STATUS.CONFIRMED,
                    description: description,
                    createdAt: new Date()
                };

                reservations.push(reservation);
                console.log('é ç´„ç”³è«‹æˆåŠŸ:', reservation);
                console.log('æ–°å¢é ç´„è¨˜éŒ„ - é›¶ä»¶ID:', reservation.partId, 'é›¶ä»¶å‹è™Ÿ:', reservation.partModel);
                alert('âœ… é ç´„ç”³è«‹æˆåŠŸï¼\n\né ç´„ç·¨è™Ÿï¼š' + reservation.id + '\né›¶ä»¶å‹è™Ÿï¼š' + currentBorrowingPart.model + '\né ç´„æœŸé–“ï¼š' + new Date(startDate).toLocaleDateString() + ' ~ ' + new Date(endDate).toLocaleDateString() + '\né ç´„æ•¸é‡ï¼š' + quantity + '\nç”³è«‹äººï¼š' + borrowerName);

            } else {
                // å³æ™‚å€Ÿå‡º - ğŸ”¥ ä¿®æ­£ï¼šç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ partId
                const borrowRecord = {
                    id: Date.now(),
                    partId: currentBorrowingPart.id, // ğŸ”¥ é‡è¦ï¼šä½¿ç”¨æ­£ç¢ºçš„é›¶ä»¶ID
                    partModel: currentBorrowingPart.model,
                    borrowerName: borrowerName,
                    borrowerEmail: borrowerEmail,
                    borrowerPhone: borrowerPhone,
                    borrowPeriod: endDate,
                    description: description,
                    borrowTime: new Date(),
                    returnTime: null,
                    status: 'å€Ÿå‡ºä¸­',
                    quantity: quantity
                };

                borrowRecords.push(borrowRecord);
                console.log('å€Ÿå‡ºç”³è«‹æˆåŠŸ:', borrowRecord);
                console.log('æ–°å¢å€Ÿå‡ºè¨˜éŒ„ - é›¶ä»¶ID:', borrowRecord.partId, 'é›¶ä»¶å‹è™Ÿ:', borrowRecord.partModel);
                alert('âœ… å€Ÿå‡ºç”³è«‹æˆåŠŸï¼\n\nå€Ÿå‡ºç·¨è™Ÿï¼š' + borrowRecord.id + '\né›¶ä»¶å‹è™Ÿï¼š' + currentBorrowingPart.model + '\nå€Ÿå‡ºæœŸé–“ï¼š' + new Date().toLocaleDateString() + ' ~ ' + new Date(endDate).toLocaleDateString() + '\nå€Ÿå‡ºæ•¸é‡ï¼š' + quantity + '\nå€Ÿç”¨äººï¼š' + borrowerName);
            }

            closeBorrowModal();
            loadParts();
            if (document.getElementById('borrowRecordsPage').classList.contains('active')) {
                loadBorrowRecords();
            }
        }

        function closeBorrowModal() {
            document.getElementById('borrowModal').style.display = 'none';
            document.getElementById('borrowerName').value = '';
            document.getElementById('borrowerEmail').value = '';
            document.getElementById('borrowerPhone').value = '';
            document.getElementById('borrowStartDate').value = '';
            document.getElementById('borrowEndDate').value = '';
            document.getElementById('borrowQuantity').value = '1';
            document.getElementById('borrowDescription').value = '';
            document.getElementById('conflictWarning').style.display = 'none';
            
            // æ¢å¾©æ¬„ä½ç‚ºå¯ç·¨è¼¯ç‹€æ…‹
            document.getElementById('borrowerName').readOnly = false;
            document.getElementById('borrowerEmail').readOnly = false;
            document.getElementById('borrowerPhone').readOnly = false;
            document.getElementById('borrowerName').style.backgroundColor = '';
            document.getElementById('borrowerEmail').style.backgroundColor = '';
            document.getElementById('borrowerPhone').style.backgroundColor = '';
            
            // ç§»é™¤é ç´„ç”³è«‹æç¤º
            const reservationNotice = document.getElementById('reservationNotice');
            if (reservationNotice) {
                reservationNotice.remove();
            }
            
            // æ¢å¾©æ¨™é¡Œç‚ºé è¨­å€¼
            const modalTitle = document.querySelector('#borrowModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'ç”³è«‹å€Ÿç”¨';
            }
            
            // ğŸ”¥ é‡ç½®ç¢ºèªç”³è«‹æŒ‰éˆ•ç‹€æ…‹
            const submitButton = document.querySelector('#borrowModal .btn-primary');
            if (submitButton) {
                submitButton.style.display = 'inline-block';
                console.log('é—œé–‰å½ˆçª—ï¼šé‡ç½®ç¢ºèªç”³è«‹æŒ‰éˆ•ç‚ºé¡¯ç¤ºç‹€æ…‹');
            }
            
            // ç§»é™¤æ•¸é‡æç¤º
            const existingHint = document.getElementById('quantityHint');
            if (existingHint) {
                existingHint.remove();
            }
            
            currentBorrowingPart = null;
        }

        // è¼‰å…¥å€Ÿå‡ºè¨˜éŒ„
        function loadBorrowRecords() {
            const tbody = document.getElementById('borrowRecordsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            const allRecords = [];
            
            borrowRecords.forEach(record => {
                allRecords.push({
                    ...record,
                    type: 'borrow',
                    dateForSort: new Date(record.borrowTime)
                });
            });
            
            reservations.forEach(reservation => {
                if (reservation.status !== RESERVATION_STATUS.CANCELLED) {
                    allRecords.push({
                        ...reservation,
                        type: 'reservation',
                        dateForSort: new Date(reservation.createdAt)
                    });
                }
            });
            
            // æŒ‰æ™‚é–“æ’åº
            allRecords.sort((a, b) => b.dateForSort - a.dateForSort);

            allRecords.forEach(record => {
                const row = document.createElement('tr');
                
                let typeCell, statusCell, actionCell;
                
                if (record.type === 'borrow') {
                    typeCell = '<span class="status-badge" style="background: #10b981; color: white;">å€Ÿå‡º</span>';
                    statusCell = '<span class="status-badge ' + (record.status === 'å€Ÿå‡ºä¸­' ? 'status-borrowed' : 'status-available') + '">' + record.status + '</span>';
                    
                    if (record.status === 'å€Ÿå‡ºä¸­' && (currentUser.role === 'admin' || currentUser.role === 'ra_staff')) {
                        actionCell = '<button class="btn btn-success" onclick="returnPart(' + record.id + ')">ç¢ºèªæ­¸é‚„</button>';
                    } else {
                        actionCell = '<span style="color: #6b7280;">-</span>';
                    }
                } else {
                    typeCell = '<span class="status-badge" style="background: #3b82f6; color: white;">é ç´„</span>';
                    statusCell = '<span class="status-badge" style="background: #10b981; color: white;">å·²ç¢ºèª</span>';
                    
                    if (record.status === RESERVATION_STATUS.CONFIRMED && (currentUser.role === 'admin' || currentUser.role === 'ra_staff')) {
                        actionCell = '<button class="btn btn-danger" onclick="cancelReservation(' + record.id + ')">å–æ¶ˆé ç´„</button>';
                    } else {
                        actionCell = '<span style="color: #6b7280;">-</span>';
                    }
                }
                
                let timeInfo = '';
                if (record.type === 'borrow') {
                    const borrowDate = new Date(record.borrowTime).toLocaleDateString();
                    const returnDate = record.borrowPeriod ? new Date(record.borrowPeriod).toLocaleDateString() : 'æœªè¨­å®š';
                    
                    if (record.status === 'å·²æ­¸é‚„' && record.returnTime) {
                        timeInfo = borrowDate + ' ~ ' + new Date(record.returnTime).toLocaleDateString() + ' (å·²æ­¸é‚„)';
                    } else {
                        timeInfo = borrowDate + ' ~ ' + returnDate + ' (å€Ÿå‡ºä¸­)';
                    }
                } else {
                    timeInfo = new Date(record.startDate).toLocaleDateString() + ' ~ ' + new Date(record.endDate).toLocaleDateString();
                }
                
                row.innerHTML = '<td>' + (record.partModel || 'N/A') + '</td><td>' + record.borrowerName + '</td><td>' + record.borrowerEmail + '</td><td>' + record.borrowerPhone + '</td><td>' + timeInfo + '</td><td>' + (record.quantity || 1) + '</td><td>' + typeCell + '</td><td>' + statusCell + '</td><td>' + record.description + '</td><td>' + actionCell + '</td>';
                tbody.appendChild(row);
            });

            if (allRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="10" style="text-align: center; color: #6b7280; padding: 30px;">æš«ç„¡å€Ÿå‡ºè¨˜éŒ„æˆ–é ç´„å–®</td>';
                tbody.appendChild(row);
            }
        }

        function returnPart(recordId) {
            const record = borrowRecords.find(r => r.id === recordId);
            if (!record) return;

            if (confirm('ç¢ºèªæ­¤é›¶ä»¶å·²æ­¸é‚„ï¼Ÿ')) {
                record.status = 'å·²æ­¸é‚„';
                record.returnTime = new Date();
                
                alert('é›¶ä»¶æ­¸é‚„æˆåŠŸï¼');
                loadBorrowRecords();
                loadParts();
            }
        }

        function cancelReservation(reservationId) {
            if (confirm('ç¢ºèªè¦å–æ¶ˆæ­¤é ç´„å—ï¼Ÿ')) {
                const reservation = reservations.find(r => r.id === reservationId);
                if (reservation) {
                    reservation.status = RESERVATION_STATUS.CANCELLED;
                    alert('é ç´„å·²å–æ¶ˆ');
                    loadBorrowRecords();
                    loadParts();
                }
            }
        }

        // ä½¿ç”¨è€…ç®¡ç†
        function loadUsers() {
            console.log('loadUsers called');
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) {
                console.log('usersTableBody not found');
                return;
            }
            
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                
                // å¦‚æœå¸³è™Ÿè¢«åœç”¨ï¼Œæ•´è¡Œé¡¯ç¤ºç‚ºç°è‰²
                if (user.isActive === false) {
                    row.style.opacity = '0.6';
                    row.style.backgroundColor = '#f3f4f6';
                }
                
                let roleDisplay = '';
                switch(user.role) {
                    case 'admin': roleDisplay = 'ç®¡ç†å“¡'; break;
                    case 'ra_staff': roleDisplay = 'RAåŒä»'; break;
                    case 'demo_user': roleDisplay = 'DEMOå€Ÿç”¨è€…'; break;
                    default: roleDisplay = 'ä½¿ç”¨è€…';
                }
                
                // ç‹€æ…‹é¡¯ç¤º
                let statusCell = '';
                if (user.isActive === true || user.isActive === undefined) {
                    statusCell = '<span style="color: #10b981; font-weight: 500;">âœ“ å•Ÿç”¨</span>';
                } else {
                    statusCell = '<span style="color: #ef4444; font-weight: 500;">âœ— åœç”¨</span>';
                }
                
                let actionCell = '';
                let passwordCell = '<button class="btn btn-secondary" onclick="openPasswordModal(\'' + user.email + '\')" style="padding: 8px 16px; font-size: 14px;">ä¿®æ”¹å¯†ç¢¼</button>';
                
                if (user.email !== currentUser.email) {
                    // è§’è‰²é¸æ“‡
                    actionCell = '<select onchange="updateUserRole(\'' + user.email + '\', this.value)" style="margin-right: 10px;">' +
                               '<option value="admin"' + (user.role === 'admin' ? ' selected' : '') + '>ç®¡ç†å“¡</option>' +
                               '<option value="ra_staff"' + (user.role === 'ra_staff' ? ' selected' : '') + '>RAåŒä»</option>' +
                               '<option value="demo_user"' + (user.role === 'demo_user' ? ' selected' : '') + '>DEMOå€Ÿç”¨è€…</option>' +
                               '</select>';
                    
                    // å•Ÿç”¨/åœç”¨æŒ‰éˆ•
                    if (user.isActive === true || user.isActive === undefined) {
                        actionCell += '<button class="btn" style="background-color: #ef4444; color: white; padding: 8px 16px; font-size: 14px; margin-right: 10px;" onclick="toggleUserStatus(\'' + user.email + '\')">åœç”¨</button>';
                    } else {
                        actionCell += '<button class="btn" style="background-color: #10b981; color: white; padding: 8px 16px; font-size: 14px; margin-right: 10px;" onclick="toggleUserStatus(\'' + user.email + '\')">å•Ÿç”¨</button>';
                    }
                    
                    // åˆªé™¤æŒ‰éˆ•
                    actionCell += '<button class="btn btn-danger" onclick="deleteUser(\'' + user.email + '\')" style="padding: 8px 16px; font-size: 14px;">åˆªé™¤</button>';
                } else {
                    actionCell = '<span style="color: #6b7280;">ç›®å‰ä½¿ç”¨è€…</span>';
                }
                
                // é¡¯ç¤ºå§“åå’Œé›»è©±ï¼Œå¦‚æœæ˜¯èˆŠè³‡æ–™æ²’æœ‰é€™äº›æ¬„ä½å‰‡é¡¯ç¤ºé è¨­å€¼
                const userName = user.name || user.email.split('@')[0];
                const userPhone = user.phone || '-';
                
                row.innerHTML = '<td>' + userName + '</td><td>' + user.email + '</td><td>' + userPhone + '</td><td>' + roleDisplay + '</td><td>' + statusCell + '</td><td>' + passwordCell + '</td><td>' + actionCell + '</td>';
                tbody.appendChild(row);
            });
            
            console.log('Users loaded:', users.length);
        }
        
        // ç¢ºä¿å‡½æ•¸åœ¨å…¨åŸŸç¯„åœå…§å¯ç”¨
        window.loadUsers = loadUsers;

        // åˆ‡æ›ä½¿ç”¨è€…ç‹€æ…‹ï¼ˆå•Ÿç”¨/åœç”¨ï¼‰
        function toggleUserStatus(email) {
            const user = users.find(u => u.email === email);
            if (!user) return;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹å•Ÿç”¨çš„ç®¡ç†å“¡
            const activeAdmins = users.filter(u => u.role === 'admin' && (u.isActive === true || u.isActive === undefined));
            if (user.role === 'admin' && (user.isActive === true || user.isActive === undefined) && activeAdmins.length === 1) {
                alert('âŒ ç„¡æ³•åœç”¨æœ€å¾Œä¸€å€‹ç®¡ç†å“¡å¸³è™Ÿï¼');
                return;
            }
            
            // åˆ‡æ›ç‹€æ…‹
            if (user.isActive === true || user.isActive === undefined) {
                if (confirm('ç¢ºå®šè¦åœç”¨æ­¤å¸³è™Ÿå—ï¼Ÿ\n\nå¸³è™Ÿï¼š' + email + '\nåœç”¨å¾Œè©²ä½¿ç”¨è€…å°‡ç„¡æ³•ç™»å…¥ç³»çµ±ã€‚')) {
                    user.isActive = false;
                    alert('âœ… å¸³è™Ÿå·²åœç”¨');
                    loadUsers();
                }
            } else {
                if (confirm('ç¢ºå®šè¦å•Ÿç”¨æ­¤å¸³è™Ÿå—ï¼Ÿ\n\nå¸³è™Ÿï¼š' + email + '\nå•Ÿç”¨å¾Œè©²ä½¿ç”¨è€…å¯ä»¥æ­£å¸¸ç™»å…¥ç³»çµ±ã€‚')) {
                    user.isActive = true;
                    alert('âœ… å¸³è™Ÿå·²å•Ÿç”¨');
                    loadUsers();
                }
            }
        }

        function updateUserRole(email, newRole) {
            const user = users.find(u => u.email === email);
            if (user && confirm('ç¢ºèªè¦è®Šæ›´æ­¤ä½¿ç”¨è€…çš„è§’è‰²å—ï¼Ÿ')) {
                user.role = newRole;
                alert('è§’è‰²è®Šæ›´æˆåŠŸï¼');
                loadUsers();
            }
        }

        // ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½
        function openPasswordModal(userEmail) {
            document.getElementById('passwordUserEmail').value = userEmail;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordUserEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function updatePassword() {
            const userEmail = document.getElementById('passwordUserEmail').value;
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!newPassword) {
                alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
                return;
            }

            if (newPassword.length < 1) {
                alert('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦1å€‹å­—å…ƒ');
                return;
            }

            const user = users.find(u => u.email === userEmail);
            if (user && confirm('ç¢ºèªè¦ä¿®æ”¹æ­¤å¸³è™Ÿçš„å¯†ç¢¼å—ï¼Ÿ')) {
                user.password = newPassword;
                alert('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼');
                closePasswordModal();
            }
        }

        // æ¸…é™¤ç‰¹å®šæ¬„ä½çš„éŒ¯èª¤
        function clearError(fieldId) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            if (errorElement) {
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }
            
            if (inputElement) {
                inputElement.style.borderColor = '#e1e5e9';
            }
        }

        // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º
        function clearAllErrors() {
            const errorElements = document.querySelectorAll('[id$="Error"]');
            errorElements.forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            
            // æ¸…é™¤ç´…æ¡†
            const inputs = document.querySelectorAll('#addUserModal input');
            inputs.forEach(input => {
                input.style.borderColor = '#e1e5e9';
            });
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            if (inputElement) {
                inputElement.style.borderColor = '#dc2626';
            }
        }

        // å³æ™‚é©—è­‰å‡½æ•¸
        function validateName() {
            const name = document.getElementById('addUserName').value.trim();
            clearError('addUserName');
            
            if (!name) {
                showError('addUserName', 'è«‹è¼¸å…¥å§“å');
                return false;
            } else if (name.length < 2) {
                showError('addUserName', 'å§“åè‡³å°‘éœ€è¦2å€‹å­—å…ƒ');
                return false;
            }
            return true;
        }

        function validateEmail() {
            const email = document.getElementById('addUserEmail').value.trim();
            clearError('addUserEmail');
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                showError('addUserEmail', 'è«‹è¼¸å…¥Email');
                return false;
            } else if (!emailRegex.test(email)) {
                showError('addUserEmail', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„Emailæ ¼å¼');
                return false;
            } else if (users.find(u => u.email === email)) {
                showError('addUserEmail', 'æ­¤Emailå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨ä¸åŒçš„Email');
                return false;
            }
            return true;
        }

        function validatePhone() {
            const phone = document.getElementById('addUserPhone').value.trim();
            clearError('addUserPhone');
            
            const phoneRegex = /^[\d\-\+\(\)\s]+$/;
            if (!phone) {
                showError('addUserPhone', 'è«‹è¼¸å…¥é›»è©±');
                return false;
            } else if (!phoneRegex.test(phone)) {
                showError('addUserPhone', 'é›»è©±æ ¼å¼ä¸æ­£ç¢ºï¼Œåªèƒ½åŒ…å«æ•¸å­—ã€ç©ºæ ¼å’Œç¬¦è™Ÿ(+-)');
                return false;
            } else if (phone.replace(/\D/g, '').length < 7) {
                showError('addUserPhone', 'é›»è©±è™Ÿç¢¼è‡³å°‘éœ€è¦7ä½æ•¸å­—');
                return false;
            }
            return true;
        }

        function validatePassword() {
            const password = document.getElementById('addUserPassword').value.trim();
            clearError('addUserPassword');
            
            if (!password) {
                showError('addUserPassword', 'è«‹è¼¸å…¥å¯†ç¢¼');
                return false;
            } else if (password.length < 6) {
                showError('addUserPassword', 'å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—å…ƒ');
                return false;
            }
            
            // å¦‚æœç¢ºèªå¯†ç¢¼å·²å¡«å¯«ï¼Œä¹Ÿè¦æª¢æŸ¥æ˜¯å¦ä¸€è‡´
            const confirmPassword = document.getElementById('addUserConfirmPassword').value.trim();
            if (confirmPassword) {
                validateConfirmPassword();
            }
            
            return true;
        }

        function validateConfirmPassword() {
            const password = document.getElementById('addUserPassword').value.trim();
            const confirmPassword = document.getElementById('addUserConfirmPassword').value.trim();
            clearError('addUserConfirmPassword');
            
            if (!confirmPassword) {
                showError('addUserConfirmPassword', 'è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼');
                return false;
            } else if (password !== confirmPassword) {
                showError('addUserConfirmPassword', 'å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
                return false;
            }
            return true;
        }

        // æ–°å¢ä½¿ç”¨è€…åŠŸèƒ½
        function openAddUserModal() {
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserPhone').value = '';
            document.getElementById('addUserPassword').value = '';
            document.getElementById('addUserConfirmPassword').value = '';
            document.getElementById('addUserRole').value = 'demo_user';
            clearAllErrors();
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserName').value = '';
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserPhone').value = '';
            document.getElementById('addUserPassword').value = '';
            document.getElementById('addUserConfirmPassword').value = '';
            document.getElementById('addUserRole').value = 'demo_user';
            clearAllErrors();
        }

        function addNewUser() {
            // åŸ·è¡Œæ‰€æœ‰é©—è­‰
            const isNameValid = validateName();
            const isEmailValid = validateEmail();
            const isPhoneValid = validatePhone();
            const isPasswordValid = validatePassword();
            const isConfirmPasswordValid = validateConfirmPassword();

            // å¦‚æœæœ‰ä»»ä½•é©—è­‰å¤±æ•—ï¼Œåœæ­¢åŸ·è¡Œ
            if (!isNameValid || !isEmailValid || !isPhoneValid || !isPasswordValid || !isConfirmPasswordValid) {
                return;
            }

            // å–å¾—æ‰€æœ‰æ¬„ä½å€¼
            const name = document.getElementById('addUserName').value.trim();
            const email = document.getElementById('addUserEmail').value.trim();
            const phone = document.getElementById('addUserPhone').value.trim();
            const password = document.getElementById('addUserPassword').value.trim();
            const role = document.getElementById('addUserRole').value;

            const newUser = {
                name: name,
                email: email,
                phone: phone,
                password: password,
                role: role,
                isActive: true
            };

            users.push(newUser);
            alert('âœ… æ–°å¢ä½¿ç”¨è€…æˆåŠŸï¼');
            closeAddUserModal();
            loadUsers();
        }

        // åˆªé™¤ä½¿ç”¨è€…åŠŸèƒ½
        function deleteUser(userEmail) {
            if (userEmail === currentUser.email) {
                alert('ç„¡æ³•åˆªé™¤ç›®å‰ç™»å…¥çš„ä½¿ç”¨è€…');
                return;
            }

            if (confirm('ç¢ºèªè¦åˆªé™¤æ­¤ä½¿ç”¨è€…å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                const userIndex = users.findIndex(u => u.email === userEmail);
                if (userIndex !== -1) {
                    users.splice(userIndex, 1);
                    alert('ä½¿ç”¨è€…å·²åˆªé™¤');
                    loadUsers();
                }
            }
        }

        // ç…§ç‰‡æ”¾å¤§é¡¯ç¤ºåŠŸèƒ½
        function showImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
    </script>
</body>
</html> 